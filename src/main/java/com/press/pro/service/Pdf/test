package com.press.pro.service.Pdf;

import com.itextpdf.text.*;
import com.itextpdf.text.pdf.*;
import com.itextpdf.text.pdf.draw.LineSeparator;
import com.press.pro.Entity.Client;
import com.press.pro.Entity.Commande;
import com.press.pro.Entity.CommandeLigne;
import com.press.pro.Entity.Parametre;
import com.press.pro.Entity.Pressing;
import org.springframework.stereotype.Service;

import java.io.ByteArrayOutputStream;
import java.io.FileOutputStream;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.time.format.DateTimeFormatter;

@Service
public class CommandePdfService {

    private static final String PDF_BASE_FOLDER = "pdfCommandes/";

    public byte[] genererCommandePdf(Commande commande) {
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        // Largeur augmentée pour plus de clarté
        Rectangle receiptSize = new Rectangle(250, 600);
        Document document = new Document(receiptSize, 10, 10, 10, 10);

        try {
            PdfWriter.getInstance(document, out);
            document.open();

            // Polices améliorées avec tailles plus adaptées
            Font fontBold = FontFactory.getFont(FontFactory.HELVETICA_BOLD, 9);
            Font fontNormal = FontFactory.getFont(FontFactory.HELVETICA, 8);
            Font fontHeader = FontFactory.getFont(FontFactory.HELVETICA_BOLD, 12);
            Font fontTitle = FontFactory.getFont(FontFactory.HELVETICA_BOLD, 10);
            Font fontSmall = FontFactory.getFont(FontFactory.HELVETICA, 7);

            Pressing pressing = commande.getPressing();
            Client client = commande.getClient();

            // =======================
            //        ENTETE AMÉLIORÉ
            // =======================
            PdfPTable header = new PdfPTable(2);
            header.setWidthPercentage(100);
            header.setWidths(new float[]{1.2f, 3f});
            header.getDefaultCell().setBorder(Rectangle.NO_BORDER);
            header.setSpacingAfter(8f);

            // LOGO avec encadrement subtil
            PdfPCell logo = new PdfPCell();
            logo.setBorder(Rectangle.BOX);
            logo.setBorderWidth(0.5f);
            logo.setBorderColor(BaseColor.LIGHT_GRAY);
            logo.setVerticalAlignment(Element.ALIGN_MIDDLE);
            logo.setHorizontalAlignment(Element.ALIGN_CENTER);
            logo.setPadding(3);
            logo.setFixedHeight(65f);

            try {
                if (pressing.getLogo() != null && pressing.getLogo().length > 0) {
                    Image img = Image.getInstance(pressing.getLogo());
                    img.scaleToFit(55, 55);
                    img.setAlignment(Image.ALIGN_CENTER);
                    logo.addElement(img);
                }
            } catch (Exception ignored) {
                Paragraph noLogo = new Paragraph("LOGO", fontSmall);
                noLogo.setAlignment(Element.ALIGN_CENTER);
                logo.addElement(noLogo);
            }

            header.addCell(logo);

            // INFOS PRESSING avec meilleur espacement
            PdfPCell info = new PdfPCell();
            info.setBorder(Rectangle.NO_BORDER);
            info.setPaddingLeft(8f);
            info.setVerticalAlignment(Element.ALIGN_MIDDLE);

            Paragraph nom = new Paragraph(pressing.getNom(), fontHeader);
            nom.setSpacingAfter(3f);
            info.addElement(nom);

            if (pressing.getAdresse() != null && !pressing.getAdresse().isEmpty()) {
                Paragraph adresse = new Paragraph(pressing.getAdresse(), fontSmall);
                adresse.setSpacingAfter(2f);
                info.addElement(adresse);
            }

            if (pressing.getEmail() != null && !pressing.getEmail().isEmpty()) {
                Paragraph email = new Paragraph("✉ " + pressing.getEmail(), fontSmall);
                email.setSpacingAfter(2f);
                info.addElement(email);
            }

            String contacts = "☎ " + pressing.getTelephone();
            if (pressing.getCel() != null && !pressing.getCel().isEmpty())
                contacts += " | " + pressing.getCel();
            Paragraph tel = new Paragraph(contacts, fontSmall);
            info.addElement(tel);

            header.addCell(info);
            document.add(header);

            // Ligne de séparation
            addSeparatorLine(document, 1f);

            // =======================
            //     N° DE REÇU STYLISÉ
            // =======================
            Long numeroLocal = getNumeroLocal(commande);
            PdfPTable recuTable = new PdfPTable(1);
            recuTable.setWidthPercentage(100);
            recuTable.setSpacingBefore(5f);
            recuTable.setSpacingAfter(5f);

            PdfPCell recuCell = new PdfPCell();
            recuCell.setBackgroundColor(new BaseColor(240, 240, 240));
            recuCell.setBorder(Rectangle.BOX);
            recuCell.setBorderWidth(1f);
            recuCell.setPadding(5f);

            Paragraph recuNo = new Paragraph("BON DE COMMANDE N° " + formatNumeroFacture(numeroLocal), fontTitle);
            recuNo.setAlignment(Element.ALIGN_CENTER);
            recuCell.addElement(recuNo);

            recuTable.addCell(recuCell);
            document.add(recuTable);

            // =======================
            // CLIENT + DATES AMÉLIORÉS
            // =======================
            PdfPTable clientDate = new PdfPTable(2);
            clientDate.setWidthPercentage(100);
            clientDate.setWidths(new float[]{2.2f, 1.8f});
            clientDate.setSpacingAfter(8f);

            DateTimeFormatter df = DateTimeFormatter.ofPattern("dd/MM/yyyy");

            // Colonne client
            PdfPCell leftCell = new PdfPCell();
            leftCell.setBorder(Rectangle.BOX);
            leftCell.setBorderWidth(0.5f);
            leftCell.setBorderColor(BaseColor.LIGHT_GRAY);
            leftCell.setPadding(5f);
            leftCell.setBackgroundColor(new BaseColor(250, 250, 250));

            Paragraph clientLabel = new Paragraph("Client", fontBold);
            clientLabel.setSpacingAfter(2f);
            leftCell.addElement(clientLabel);

            leftCell.addElement(new Paragraph(
                    client != null ? client.getNom() : "CLIENT DIVERS", fontNormal));

            if (client != null && client.getAdresse() != null && !client.getAdresse().isEmpty()) {
                Paragraph adr = new Paragraph(client.getAdresse(), fontSmall);
                adr.setSpacingBefore(2f);
                leftCell.addElement(adr);
            }

            clientDate.addCell(leftCell);

            // Colonne dates
            PdfPCell rightCell = new PdfPCell();
            rightCell.setBorder(Rectangle.BOX);
            rightCell.setBorderWidth(0.5f);
            rightCell.setBorderColor(BaseColor.LIGHT_GRAY);
            rightCell.setPadding(5f);
            rightCell.setBackgroundColor(new BaseColor(250, 250, 250));

            Paragraph datesLabel = new Paragraph("Dates", fontBold);
            datesLabel.setSpacingAfter(2f);
            rightCell.addElement(datesLabel);

            rightCell.addElement(new Paragraph("Réception: " +
                    (commande.getDateReception() != null ? commande.getDateReception().format(df) : "-"), fontSmall));

            Paragraph livr = new Paragraph("Livraison: " +
                    (commande.getDateLivraison() != null ? commande.getDateLivraison().format(df) : "-"), fontSmall);
            livr.setSpacingBefore(2f);
            rightCell.addElement(livr);

            clientDate.addCell(rightCell);
            document.add(clientDate);

            // =======================
            //       LIGNES DE COMMANDE AMÉLIORÉES
            // =======================
            PdfPTable lignesTable = new PdfPTable(4);
            lignesTable.setWidthPercentage(100);
            lignesTable.setWidths(new float[]{3.5f, 0.8f, 1.2f, 1.5f});
            lignesTable.setSpacingAfter(8f);

            // En-tête avec style
            addStyledTableHeader(lignesTable, new String[]{"Article", "Qté", "P.U", "Montant"}, fontBold);

            // Lignes avec alternance de couleurs
            int index = 0;
            for (CommandeLigne ligne : commande.getLignes()) {
                Parametre param = ligne.getParametre();
                BaseColor bgColor = (index % 2 == 0) ? BaseColor.WHITE : new BaseColor(248, 248, 248);

                String ab = param != null ? abregerService(param.getService()) : "-";
                String article = param != null ? param.getArticle() : "-";
                String articleFinal = article + " (" + ab + ")";

                double pu = param != null ? param.getPrix() : 0;
                double montantNet = ligne.getQuantite() * pu;

                lignesTable.addCell(createStyledCell(articleFinal, fontNormal, Element.ALIGN_LEFT, bgColor));
                lignesTable.addCell(createStyledCell(String.valueOf(ligne.getQuantite()), fontNormal, Element.ALIGN_CENTER, bgColor));
                lignesTable.addCell(createStyledCell(String.format("%.0f F", pu), fontNormal, Element.ALIGN_RIGHT, bgColor));
                lignesTable.addCell(createStyledCell(String.format("%.0f F", montantNet), fontBold, Element.ALIGN_RIGHT, bgColor));

                index++;
            }

            document.add(lignesTable);

            // Ligne de séparation avant totaux
            addSeparatorLine(document, 0.5f);

            // =======================
            //        TOTAUX AMÉLIORÉS
            // =======================
            double montantTotalBrut = commande.getLignes().stream()
                    .mapToDouble(ligne -> {
                        double pu = ligne.getParametre() != null ? ligne.getParametre().getPrix() : 0;
                        return ligne.getQuantite() * pu;
                    })
                    .sum();

            double remise = commande.getRemise();
            double montantApresRemise = montantTotalBrut - remise;
            double paye = commande.getMontantPaye();
            double resteAPayer = montantApresRemise - paye;

            PdfPTable totaux = new PdfPTable(2);
            totaux.setWidthPercentage(100);
            totaux.setWidths(new float[]{2.5f, 1.5f});
            totaux.setSpacingBefore(5f);
            totaux.setSpacingAfter(8f);

            // Sous-total
            totaux.addCell(createTotalCell("Montant Total", fontNormal, false));
            totaux.addCell(createTotalCell(String.format("%.0f F", montantTotalBrut), fontNormal, true));

            // Remise
            if (remise > 0) {
                totaux.addCell(createTotalCell("Remise", fontNormal, false));
                totaux.addCell(createTotalCell(String.format("- %.0f F", remise), fontNormal, true));
            }

            // Net à payer
            totaux.addCell(createTotalCell("Net à Payer", fontBold, false, new BaseColor(230, 230, 230)));
            totaux.addCell(createTotalCell(String.format("%.0f F", montantApresRemise), fontBold, true, new BaseColor(230, 230, 230)));

            // Montant payé
            if (paye > 0) {
                totaux.addCell(createTotalCell("Montant Payé", fontNormal, false));
                totaux.addCell(createTotalCell(String.format("%.0f F", paye), fontNormal, true));
            }

            // Reste à payer - en surbrillance si > 0
            BaseColor resteBg = resteAPayer > 0 ? new BaseColor(255, 245, 230) : new BaseColor(230, 255, 230);
            totaux.addCell(createTotalCell("Reste à Payer", fontBold, false, resteBg));
            totaux.addCell(createTotalCell(String.format("%.0f F", resteAPayer), fontBold, true, resteBg));

            document.add(totaux);

            // Ligne de séparation finale
            addSeparatorLine(document, 1f);

            // =======================
            // MESSAGE DE FIN
            // =======================
            Paragraph merci = new Paragraph("Merci pour votre confiance!", fontTitle);
            merci.setAlignment(Element.ALIGN_CENTER);
            merci.setSpacingBefore(8f);
            document.add(merci);

            document.close();

            // SAVE PDF
            String folder = PDF_BASE_FOLDER + pressing.getNom().replaceAll("[^a-zA-Z0-9]", "_") + "/";
            Files.createDirectories(Paths.get(folder));
            try (FileOutputStream fos = new FileOutputStream(folder + "commande_" + commande.getId() + ".pdf")) {
                fos.write(out.toByteArray());
            }

        } catch (Exception e) {
            throw new RuntimeException("Erreur PDF thermique : " + e.getMessage(), e);
        }

        return out.toByteArray();
    }

    // ==========================
    //       UTILITAIRES AMÉLIORÉS
    // ==========================

    private void addSeparatorLine(Document document, float width) throws DocumentException {
        LineSeparator line = new LineSeparator();
        line.setLineWidth(width);
        line.setLineColor(BaseColor.LIGHT_GRAY);
        document.add(new Chunk(line));
        document.add(Chunk.NEWLINE);
    }

    private PdfPCell createStyledCell(String text, Font font, int alignment, BaseColor bgColor) {
        PdfPCell cell = new PdfPCell(new Phrase(text, font));
        cell.setHorizontalAlignment(alignment);
        cell.setBorder(Rectangle.NO_BORDER);
        cell.setPadding(4f);
        cell.setBackgroundColor(bgColor);
        return cell;
    }

    private PdfPCell createTotalCell(String text, Font font, boolean isAmount) {
        return createTotalCell(text, font, isAmount, null);
    }

    private PdfPCell createTotalCell(String text, Font font, boolean isAmount, BaseColor bgColor) {
        PdfPCell cell = new PdfPCell(new Phrase(text, font));
        cell.setHorizontalAlignment(isAmount ? Element.ALIGN_RIGHT : Element.ALIGN_LEFT);
        cell.setBorder(Rectangle.NO_BORDER);
        cell.setPadding(4f);
        if (bgColor != null) {
            cell.setBackgroundColor(bgColor);
        }
        return cell;
    }

    private void addStyledTableHeader(PdfPTable table, String[] headers, Font font) {
        for (String h : headers) {
            PdfPCell cell = new PdfPCell(new Phrase(h, font));
            cell.setHorizontalAlignment(Element.ALIGN_CENTER);
            cell.setPadding(4f);
            cell.setBackgroundColor(new BaseColor(200, 200, 200));
            cell.setBorder(Rectangle.BOX);
            cell.setBorderWidth(0.5f);
            table.addCell(cell);
        }
    }

    private String abregerService(String s) {
        if (s == null || s.isBlank()) return "-";
        s = s.toUpperCase().replace("+", " ");
        String[] mots = s.split("\\s+");
        StringBuilder a = new StringBuilder();
        for (String m : mots) {
            if (!m.isBlank()) a.append(m.charAt(0));
            if (a.length() == 3) break;
        }
        return a.toString();
    }

    private long getNumeroLocal(Commande c) {
        Pressing p = c.getPressing();
        return p.getCommandes().stream().filter(x -> x.getId() <= c.getId()).count();
    }

    private String formatNumeroFacture(Long id) {
        return String.format("%09d", id == null ? 0L : id);
    }

    private PdfPCell createCellLeft(String text, Font font) {
        PdfPCell c = new PdfPCell(new Phrase(text, font));
        c.setHorizontalAlignment(Element.ALIGN_LEFT);
        c.setBorder(Rectangle.NO_BORDER);
        return c;
    }

    private PdfPCell createCellCenter(String text, Font font) {
        PdfPCell c = new PdfPCell(new Phrase(text, font));
        c.setHorizontalAlignment(Element.ALIGN_CENTER);
        c.setBorder(Rectangle.NO_BORDER);
        return c;
    }

    private PdfPCell createCellRight(String text, Font font) {
        PdfPCell c = new PdfPCell(new Phrase(text, font));
        c.setHorizontalAlignment(Element.ALIGN_RIGHT);
        c.setBorder(Rectangle.NO_BORDER);
        return c;
    }
}